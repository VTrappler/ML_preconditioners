schema: '2.0'
stages:
  generate_data:
    cmd: python3.10 /home/prec_data/data_generation.py --config /home/smoke/config.yaml
    deps:
    - path: ../prec_data/data_generation.py
      md5: da8a2b9ec578b42827bf53b02610227e
      size: 3647
    params:
      config.yaml:
        data.data_folder: /root/raw_data/data_40_large
        data.nsamples: 50000
        model.dimension: 40
        model.window: 10
    outs:
    - path: /root/raw_data/data_40_large/tlm.memmap
      md5: 6cea3c3e1972b9be048014b6f8e264c5
      size: 3200000000
    - path: /root/raw_data/data_40_large/x.memmap
      md5: 62f11c64556e226c7c51f1e7259a8040
      size: 8000000
  train:
    cmd: source /home/.set_environment_variables.sh && python3.10 /home/smoke/training.py
      --config config.yaml --exp-name smoke_train_tr
    deps:
    - path: ../prec_data/data.py
      md5: 5a4f754e59a2202ad6284151222ab4ee
      size: 13442
    - path: /root/raw_data/data_40_large/tlm.memmap
      md5: 6cea3c3e1972b9be048014b6f8e264c5
      size: 3200000000
    - path: /root/raw_data/data_40_large/x.memmap
      md5: 62f11c64556e226c7c51f1e7259a8040
      size: 8000000
    - path: config.yaml
      md5: 2af0cc6bd74de6430043e061a66cd806
      size: 503
    - path: training.py
      md5: e77f8d740465e0934333de203f7f376e
      size: 5337
    params:
      config.yaml:
        architecture.batch_size: 8
        architecture.class: SVDConvolutionalSPAI
        architecture.n_layers: 8
        architecture.rank: 40
        data.data_folder: /root/raw_data/data_40_large
        model.dimension: 40
        optimizer.epochs: 25
    outs:
    - path: artifacts/metrics.yaml
      md5: 0d1d4d85606c6a4f273cefa5c573619a
      size: 292
    - path: artifacts/mlflow_run_id.yaml
      md5: c420423e0abc9cc056829f29653c3d3c
      size: 99
    - path: artifacts/training_logs.csv
      md5: 831f209633eac7477a8b6ef7660d7e5b
      size: 234640
  data_assim:
    cmd: source /home/.set_environment_variables.sh && python3.10 data_assimilation_benchmark_wip.py
      --config config.yaml --run-id-yaml /home/smoke/artifacts/mlflow_run_id.yaml
    deps:
    - path: artifacts/mlflow_run_id.yaml
      md5: c420423e0abc9cc056829f29653c3d3c
      size: 99
    - path: artifacts/training_logs.csv
      md5: 831f209633eac7477a8b6ef7660d7e5b
      size: 234640
    - path: config.yaml
      md5: 7aea0f53ce63df280cdbbddcfd74c108
      size: 503
    - path: data_assimilation_benchmark_wip.py
      md5: da94577c464fcf87f2382184f28f319e
      size: 14524
    params:
      config.yaml:
        DA.n_cycle: 20
        DA.n_inner: 100
        DA.n_outer: 5
        model.window: 10
    outs:
    - path: artifacts/DA_logs.csv
      md5: 0c1bf1bd985fcd88816bc3b06edcecb3
      size: 210628
    - path: artifacts/cond_niter_boxplot.png
      md5: 64d2c2172a9a4943078688c944d1ba87
      size: 46906
    - path: artifacts/res_inner_loop.png
      md5: d1dbb29b38dd93873d66aceedef25fb8
      size: 298172
  test:
    cmd: source /home/.set_environment_variables.sh &&  python3.10 test.py --run-id-yaml
      /home/smoke/artifacts/mlflow_run_id.yaml
    deps:
    - path: artifacts/mlflow_run_id.yaml
      md5: c420423e0abc9cc056829f29653c3d3c
      size: 99
    - path: config.yaml
      md5: 2af0cc6bd74de6430043e061a66cd806
      size: 503
    - path: test.py
      md5: a03254f7903f07a20d717062a555cde7
      size: 9230
    - path: training.py
      md5: e77f8d740465e0934333de203f7f376e
      size: 5337
    params:
      config.yaml:
        data.data_folder: /root/raw_data/data_40_large
    outs:
    - path: artifacts/condition_numbers.png
      md5: 6fbaff10b45bc75aba4a8c21fc0d876c
      size: 24653
    - path: artifacts/preconditioning.png
      md5: 01d8da0ea48c26d2fa62ea28fd267ab5
      size: 85331
    - path: artifacts/sanity_check.png
      md5: cd7239feb6117dd95b23933990cd296f
      size: 47470
    - path: artifacts/svd_approximation.png
      md5: 5a7b57e25ff1a7da94581b3fcfbcc815
      size: 152918
